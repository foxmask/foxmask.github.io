<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Trigger Happy running softly with RQ - Le Free de la Passion</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://www.foxmask.org/post/2016/02/15/trigger-happy-running-softly-with-rq/">

        <meta name="author" content="foxmask" />
        <meta name="keywords" content="Django,TriggerHappy" />
        <meta name="description" content="TriggerHappy and Celery Actually, Trigger Happy works perlfectly with Celery, but.... there is a but. Sometimes, (once a week) celery stays stuck without any visible reason. No error logs occur, and even in DEBUG level, no log appear at all. The logfile remain as is (and yes the disk is …" />

        <meta property="og:site_name" content="Le Free de la Passion" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Trigger Happy running softly with RQ"/>
        <meta property="og:url" content="https://www.foxmask.org/post/2016/02/15/trigger-happy-running-softly-with-rq/"/>
        <meta property="og:description" content="TriggerHappy and Celery Actually, Trigger Happy works perlfectly with Celery, but.... there is a but. Sometimes, (once a week) celery stays stuck without any visible reason. No error logs occur, and even in DEBUG level, no log appear at all. The logfile remain as is (and yes the disk is …"/>
        <meta property="article:published_time" content="2016-02-15" />
            <meta property="article:section" content="Techno" />
            <meta property="article:tag" content="Django" />
            <meta property="article:tag" content="TriggerHappy" />
            <meta property="article:author" content="foxmask" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://www.foxmask.org/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://www.foxmask.org/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://www.foxmask.org/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://www.foxmask.org/theme/css/style.css" type="text/css"/>

        <link href="https://www.foxmask.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion ATOM Feed"/>

        <link href="https://www.foxmask.org/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Le Free de la Passion RSS Feed"/>
        <link href="https://www.foxmask.org/feeds/techno.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion Techno ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://www.foxmask.org/" class="navbar-brand">
Le Free de la Passion            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://www.foxmask.org/pages/a-propos">
                             À propos
                          </a></li>
                        <li >
                            <a href="https://www.foxmask.org/category/games.html">Games</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/general.html">General</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/korea.html">Korea</a>
                        </li>
                        <li class="active">
                            <a href="https://www.foxmask.org/category/techno.html">Techno</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://www.foxmask.org/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://www.foxmask.org/post/2016/02/15/trigger-happy-running-softly-with-rq/"
                       rel="bookmark"
                       title="Permalink to Trigger Happy running softly with RQ">
                        Trigger Happy running softly with RQ
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-02-15T19:30:00+01:00"> lun. 15 février 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://www.foxmask.org/tag/django.html">Django</a>
        /
	<a href="https://www.foxmask.org/tag/triggerhappy.html">TriggerHappy</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>TriggerHappy and Celery</h2>
<p>Actually, Trigger Happy works perlfectly with <a href="http://celery.readthedocs.org/">Celery</a>, but.... there is a but.</p>
<p>Sometimes, (once a week) celery stays stuck without any visible reason. </p>
<p>No error logs occur, and even in DEBUG level, no log appear at all. The logfile remain as is (and yes the disk is not full:)</p>
<p>As this is very annoying for me, I went on <a href="irc://irc.freenode.net/celery">#celery@freenode</a> to try to get some details about this behavior, before breaking everything ...</p>
<p>Here, we told me that this behavior was also met with AMQ as broker (when I currently use REDIS).</p>
<h2>TriggerHappy and RQ</h2>
<p>So I decide to give a try to <a href="http://python-rq.org">Python-RQ</a></p>
<p>His (well known) author presents it as follow :</p>
<blockquote>
<p>Python RQ (Redis Queue) is a simple Python library for queueing jobs and processing them in the background with workers
This project has been inspired by the good parts of Celery, </p>
</blockquote>
<p>So to integrate RQ with TriggerHappy here is what I should do :</p>
<ol>
<li>I installed django-rq that I added to <em>INSTALLED_APPS</em> in the <strong>settings.py</strong> file.</li>
<li>to not break the existing way (with Celery) that (almost) works perfectly, I changed few details in the tasks.py module :</li>
</ol>
<p>before </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>

<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">reading</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">publishing</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>

<p>after </p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django_rq</span> <span class="kn">import</span> <span class="n">job</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="nd">@job</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">reading</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="nd">@job</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">)</span>
<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">publishing</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>

<p>Those tasks are executed by celery with the decorator <strong>@shared_task</strong> (with its own scheduler) or by the RQ with the <strong>@job</strong> decorator, through some crontab tasks, with management commands. As RQ asole use my_tasks.delay(), I dont have to change anything else, other than just adding a @job decorator.</p>
<p>I perfectly know that it's not satifying because if Celery or RQ is not installed, the decorator call with fail and the tasks wont happen.
It's just for testing purpose :) That way, I'm able to compare performance between the two solutions, one weight and one very light.</p>
<p>Surprisingly, the weight win by handling my reading tasks in less than a seconde for ~50triggers against 30sec for the light one. For the publishing tasks, they are neck and neck. But one thing hangs in the balance actually against celery, it is out of order once a week. The process are not dead, the log does not move, the query I made with celery inspect and so on, respond perfectly.</p>
<p>As my project is not so overloaded I can say that the cursor between something a "little bit slow" and something "out of order" is quickly choosen :)</p>
<p>So at least if you want to give a try to <a href="http://python-rq.org">RQ</a> with TriggerHappy, the stuff that will need to be handle, will continue to work.</p>
<p>Here I provide the line I enter in my crontab :</p>
<div class="highlight"><pre><span></span><code>*/12<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>.<span class="w"> </span>/my/env/bin/activate<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/my/env/th/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./manage.py<span class="w"> </span>fire_read_data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>../bin/rqworker-default-burst.sh
*/15<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>.<span class="w"> </span>/my/env/bin/activate<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/my/env/th/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./manage.py<span class="w"> </span>fire_publish_data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>../bin/rqworker-high-burst.sh
*/20<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>.<span class="w"> </span>/my/env/bin/activate<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/my/env/th/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./manage.py<span class="w"> </span>fire_get_outside_data<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>../bin/rqworker-low-burst.sh
</code></pre></div>

<p>and the content of, for example, rqworker-default-burst.sh</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
python<span class="w"> </span>manage.py<span class="w"> </span>rqworker<span class="w"> </span>default<span class="w"> </span>--burst<span class="w"> </span><span class="p">&amp;</span>
</code></pre></div>

<p>Yes I like to spawn a lot :)</p>
<h2>A Question to finish</h2>
<p>I take the opportunity of this post to ask you a question :</p>
<p>If I want to support Celery and RQ for my tasks, one should I write a decorator that could handle each of them.
Is there a way to write a generic decorator that will permit to be inherited to handle each of them ?</p>
<p>Thus in my tasks.py I'll be able to just do </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django_th.my_powerful_decorator</span> <span class="kn">import</span> <span class="n">jobth</span>


<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="nd">@jobth</span>
<span class="k">def</span> <span class="nf">reading</span><span class="p">():</span>
   <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>

<p>and <strong>jobth</strong> will check which of the two Queueing system is here and handled the right decorator</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://www.foxmask.org/post/2015/10/02/trigger-happy-stats-requete-et-proposition/">Trigger-Happy, stats, requête et proposition</a></li>
        <li><a href="https://www.foxmask.org/post/2015/09/08/trigger-happy-de-tout-de-rien-la-vie/">Trigger Happy, de tout, de rien, la vie</a></li>
        <li><a href="https://www.foxmask.org/post/2015/08/24/shoot-an-arrow-with-ansible-in-the-triggerhappy-target/">Shoot an Arrow with Ansible in the TriggerHappy target</a></li>
        <li><a href="https://www.foxmask.org/post/2015/08/18/django-trigger-happy-0-11-0-english-version/">Django Trigger Happy 0.11.0 English Version</a></li>
        <li><a href="https://www.foxmask.org/post/2015/08/17/django-trigger-happy-0-11-0/">Django Trigger Happy 0.11.0</a></li>
        <li><a href="https://www.foxmask.org/post/2015/07/17/revue-technique-django-inside-semaine-du-13-juillet-2015/">Revue Technique, Django Inside, semaine du 13/07/2015</a></li>
        <li><a href="https://www.foxmask.org/post/2015/04/23/django-trigger-happy-0-10-x-and-his-friends/">Django Trigger Happy 0.10.x and his friends</a></li>
        <li><a href="https://www.foxmask.org/post/2015/04/21/django-trigger-happy-0-10-x-et-ses-amis/">Django Trigger Happy 0.10.x et ses amis</a></li>
    </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="/feeds/all.rss.xml" target="_blank">FoxMaSk RSS</a>
    </li>
    <li class="list-group-item">
      <a href="https://python.org/" target="_blank">Python</a>
    </li>
    <li class="list-group-item">
      <a href="https://pycon.fr/" target="_blank">PyConFr</a>
    </li>
    <li class="list-group-item">
      <a href="https://pycon.kr/" target="_blank">PyConKr</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.djangoproject.com/" target="_blank">Django</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.django-rest-framework.org/" target="_blank">DRF</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.ansible.com/" target="_blank">Ansible</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.coree-culture.org/?lang=fr" target="_blank">Centre Culturel Coréen</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2023 FoxMaSk
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>Unless otherwise stated, all articles are published under the <a href="http://www.wtfpl.net/about/">WTFPL</a> license.</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://www.foxmask.org/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://www.foxmask.org/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://www.foxmask.org/theme/js/respond.min.js"></script>


    <script src="https://www.foxmask.org/theme/js/bodypadding.js"></script>


</body>
</html>