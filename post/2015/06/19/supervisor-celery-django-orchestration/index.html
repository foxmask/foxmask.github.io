<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Supervisor Celery Django : Orchestration - Le Free de la Passion</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://www.foxmask.org/post/2015/06/19/supervisor-celery-django-orchestration/">

        <meta name="author" content="foxmask" />
        <meta name="keywords" content="Celery,Django,Supervisor" />
        <meta name="description" content="Dans ce billet je vais aborder un triplet que chacun connait surement et a déjà dû le mettre en place, mais j&#39;irai posé là, comme à mon habitude, un retour d&#39;xp qui m&#39;est propre et pourrait servir à de nouveaux venus sur django et l&#39;administration de nos instances avec ce …" />

        <meta property="og:site_name" content="Le Free de la Passion" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Supervisor Celery Django : Orchestration"/>
        <meta property="og:url" content="https://www.foxmask.org/post/2015/06/19/supervisor-celery-django-orchestration/"/>
        <meta property="og:description" content="Dans ce billet je vais aborder un triplet que chacun connait surement et a déjà dû le mettre en place, mais j&#39;irai posé là, comme à mon habitude, un retour d&#39;xp qui m&#39;est propre et pourrait servir à de nouveaux venus sur django et l&#39;administration de nos instances avec ce …"/>
        <meta property="article:published_time" content="2015-06-19" />
            <meta property="article:section" content="Techno" />
            <meta property="article:tag" content="Celery" />
            <meta property="article:tag" content="Django" />
            <meta property="article:tag" content="Supervisor" />
            <meta property="article:author" content="foxmask" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://www.foxmask.org/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://www.foxmask.org/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://www.foxmask.org/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://www.foxmask.org/theme/css/style.css" type="text/css"/>

        <link href="https://www.foxmask.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion ATOM Feed"/>

        <link href="https://www.foxmask.org/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Le Free de la Passion RSS Feed"/>
        <link href="https://www.foxmask.org/feeds/techno.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion Techno ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://www.foxmask.org/" class="navbar-brand">
Le Free de la Passion            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://www.foxmask.org/pages/a-propos">
                             À propos
                          </a></li>
                        <li >
                            <a href="https://www.foxmask.org/category/games.html">Games</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/general.html">General</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/korea.html">Korea</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/link.html">Link</a>
                        </li>
                        <li class="active">
                            <a href="https://www.foxmask.org/category/techno.html">Techno</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://www.foxmask.org/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://www.foxmask.org/post/2015/06/19/supervisor-celery-django-orchestration/"
                       rel="bookmark"
                       title="Permalink to Supervisor Celery Django : Orchestration">
                        Supervisor Celery Django : Orchestration
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-06-19T10:30:00+02:00"> ven. 19 juin 2015</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://www.foxmask.org/tag/celery.html">Celery</a>
        /
	<a href="https://www.foxmask.org/tag/django.html">Django</a>
        /
	<a href="https://www.foxmask.org/tag/supervisor.html">Supervisor</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Dans ce billet je vais aborder un triplet que chacun connait surement et
a déjà dû le mettre en place, mais j'irai posé là, comme à mon habitude,
un retour d'xp qui m'est propre et pourrait servir à de nouveaux venus
sur <a href="https://www.djangoproject.com/">django</a> et l'administration de nos
instances avec ce framework.</p>
<p>une intro vite fait sur ces outils tout de même au cas où je parlerai
chinois ;)</p>
<ul>
<li>
<p>Celery  </p>
<blockquote>
<p>est un système distribué simple, flexible et fiable pour traiter
de grandes quantités de messages, tout en fournissant des
opérations avec les outils nécessaires pour maintenir un tel
système.</p>
</blockquote>
</li>
<li>
<p>Supervisor  </p>
<blockquote>
<p>est un système client / serveur qui permet à ses utilisateurs de
surveiller et de contrôler un certain nombre de processus sur les
systèmes d'exploitation de type UNIX.</p>
</blockquote>
</li>
</ul>
<p><em>Comme tout à chacun (d'entre nous) on cherche à maintenir nos
applications "en vie" en les faisant démarrer comme services et les
animées par des tâches (récursives ou non). C'est là le but de ces
outils !</em></p>
<h3><a href="https://celery.readthedocs.org">Celery</a></h3>
<p>Donc pour démarrer on aura besoin dans son projet django de créer le
fichier suivant permettant tout simplement d'aller à la pêche aux tâches
des applications django indiquées dans le settings.INSTALLED_APPS.</p>
<p><strong>celery.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s1">&#39;mon_projet.settings&#39;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;mon_projet&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s1">&#39;django.conf:settings&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">)</span>
</code></pre></div>

<p>Ensuite on pourrait avoir besoin de tâches récurrentes qui doivent être
définies dans le settings de son projet (et pas dans celery.py comme je
l'ai cru en parcourant la doc celery)</p>
<p><strong>mon_projet/settings.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">CELERYBEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;add-every-hour-cache&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;mon_app.tasks.read_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s1">&#39;27,54&#39;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s1">&#39;add-every-hour-publish&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;mon_app.tasks.publish_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s1">&#39;59&#39;</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<p>Bizarreries :</p>
<p>Ici j'étais parti pour écrire, telle une vraie crontab,</p>
<div class="highlight"><pre><span></span><code><span class="n">CELERYBEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;every-hour-put-in-cache&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;mon_app.tasks.read_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s1">&#39;*/27&#39;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s1">&#39;add-every-hour-publish&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;mon_app.tasks.publish_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s1">&#39;*/60&#39;</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<p>Seulement au lancement du "beat" je me suis mangé une erreur sur le
contenu de <code>minute</code> qui doit être compris en 1 et 59... Or dans une
crontab je peux tout aussi bien écrire <code>*/360</code> sur le range "<code>minutes</code>"
si ca me chante :P<br>
Ensuite le <code>*/27</code> foire tout aussi bien. Le beat démarre à 27 minutes,
puis 54 minutes .... et 00 ...<br>
Même comportement avec <code>*/59</code> (à la place de */60), il démarre bien à
59 minutes .... puis à 00 ...</p>
<p>Enfin, ensuite voici un exemple de tâches qui pourrait être déclenchées
à intervalle régulier<br>
<strong>mon_app/tasks.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">shared_task</span>

<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">read_data</span><span class="p">():</span>
        <span class="o">....</span>


<span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">publish_data</span><span class="p">():</span>
        <span class="o">...</span>
</code></pre></div>

<p>au lancement du beat (qui gère la crontab) on obtient donc :</p>
<div class="highlight"><pre><span></span><code> <span class="err">$</span> <span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">th</span> <span class="n">beat</span> <span class="o">-</span><span class="n">l</span> <span class="n">debug</span>
<span class="n">celery</span> <span class="n">beat</span> <span class="n">v3</span><span class="mf">.1.18</span> <span class="p">(</span><span class="n">Cipater</span><span class="p">)</span> <span class="ow">is</span> <span class="n">starting</span><span class="o">.</span>
<span class="n">__</span>    <span class="o">-</span>    <span class="o">...</span> <span class="n">__</span>   <span class="o">-</span>        <span class="n">_</span>
<span class="n">Configuration</span> <span class="o">-&gt;</span>
    <span class="o">.</span> <span class="n">broker</span> <span class="o">-&gt;</span> <span class="n">redis</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">6379</span><span class="o">/</span><span class="mi">10</span>
    <span class="o">.</span> <span class="n">loader</span> <span class="o">-&gt;</span> <span class="n">celery</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">AppLoader</span>
    <span class="o">.</span> <span class="n">scheduler</span> <span class="o">-&gt;</span> <span class="n">celery</span><span class="o">.</span><span class="n">beat</span><span class="o">.</span><span class="n">PersistentScheduler</span>
    <span class="o">.</span> <span class="n">db</span> <span class="o">-&gt;</span> <span class="n">celerybeat</span><span class="o">-</span><span class="n">schedule</span>
    <span class="o">.</span> <span class="n">logfile</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">stderr</span><span class="p">]</span><span class="o">@%</span><span class="n">DEBUG</span>
    <span class="o">.</span> <span class="n">maxinterval</span> <span class="o">-&gt;</span> <span class="n">now</span> <span class="p">(</span><span class="mi">0</span><span class="n">s</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">117</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">default</span> <span class="n">socket</span> <span class="n">timeout</span> <span class="n">to</span> <span class="mi">30</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">117</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">beat</span><span class="p">:</span> <span class="n">Starting</span><span class="o">...</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">134</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Current</span> <span class="n">schedule</span><span class="p">:</span>



<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">134</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">beat</span><span class="p">:</span> <span class="n">Ticking</span> <span class="k">with</span> <span class="nb">max</span> <span class="n">interval</span><span class="o">-&gt;</span><span class="mf">5.00</span> <span class="n">minutes</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="mi">169</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">beat</span><span class="p">:</span> <span class="n">Waking</span> <span class="n">up</span> <span class="ow">in</span> <span class="mf">5.00</span> <span class="n">minutes</span><span class="o">.</span>
</code></pre></div>

<p>le lancement du worker donne ceci à son tour</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span> <span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">th</span> <span class="n">worker</span> <span class="o">--</span><span class="n">autoscale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span> <span class="o">-</span><span class="n">l</span> <span class="n">debug</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">087</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Preparing</span> <span class="n">bootsteps</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">094</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Building</span> <span class="n">graph</span><span class="o">...</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">095</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">New</span> <span class="n">boot</span> <span class="n">order</span><span class="p">:</span> <span class="p">{</span><span class="n">Beat</span><span class="p">,</span> <span class="n">Timer</span><span class="p">,</span> <span class="n">Hub</span><span class="p">,</span> <span class="n">Queues</span> <span class="p">(</span><span class="n">intra</span><span class="p">),</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Autoscaler</span><span class="p">,</span> <span class="n">StateDB</span><span class="p">,</span> <span class="n">Autoreloader</span><span class="p">,</span> <span class="n">Consumer</span><span class="p">}</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">116</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Preparing</span> <span class="n">bootsteps</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">117</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Building</span> <span class="n">graph</span><span class="o">...</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">136</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">New</span> <span class="n">boot</span> <span class="n">order</span><span class="p">:</span> <span class="p">{</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Events</span><span class="p">,</span> <span class="n">Mingle</span><span class="p">,</span> <span class="n">Gossip</span><span class="p">,</span> <span class="n">Tasks</span><span class="p">,</span> <span class="n">Control</span><span class="p">,</span> <span class="n">Heart</span><span class="p">,</span> <span class="n">event</span> <span class="n">loop</span><span class="p">}</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">140</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">trigger</span><span class="o">-</span><span class="n">happy</span><span class="o">.</span><span class="n">eu</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">celery</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">worker</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">161</span><span class="p">:</span> <span class="n">CDeprecationWarning</span><span class="p">:</span> 
<span class="n">Starting</span> <span class="kn">from</span> <span class="nn">version</span> <span class="mf">3.2</span> <span class="n">Celery</span> <span class="n">will</span> <span class="n">refuse</span> <span class="n">to</span> <span class="n">accept</span> <span class="n">pickle</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span>

 <span class="o">--------------</span> <span class="n">celery</span><span class="nd">@monserver</span> <span class="n">v3</span><span class="mf">.1.18</span> <span class="p">(</span><span class="n">Cipater</span><span class="p">)</span>
<span class="o">----</span> <span class="o">****</span> <span class="o">-----</span> 
<span class="o">---</span> <span class="o">*</span> <span class="o">***</span>  <span class="o">*</span> <span class="o">--</span> <span class="n">Linux</span><span class="o">-</span><span class="mf">2.6.32</span><span class="o">-</span><span class="mi">042</span><span class="n">stab106</span><span class="mf">.4</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">debian</span><span class="o">-</span><span class="mf">8.1</span>
<span class="o">--</span> <span class="o">*</span> <span class="o">-</span> <span class="o">****</span> <span class="o">---</span> 
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="p">[</span><span class="n">config</span><span class="p">]</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="o">.&gt;</span> <span class="n">app</span><span class="p">:</span>         <span class="n">th</span><span class="p">:</span><span class="mh">0x7f85f6883b50</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="o">.&gt;</span> <span class="n">transport</span><span class="p">:</span>   <span class="n">redis</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">6379</span><span class="o">/</span><span class="mi">10</span>
<span class="o">-</span> <span class="o">**</span> <span class="o">----------</span> <span class="o">.&gt;</span> <span class="n">results</span><span class="p">:</span>     <span class="n">disabled</span>
<span class="o">-</span> <span class="o">***</span> <span class="o">---</span> <span class="o">*</span> <span class="o">---</span> <span class="o">.&gt;</span> <span class="n">concurrency</span><span class="p">:</span> <span class="mi">2</span> <span class="p">(</span><span class="n">prefork</span><span class="p">)</span>
<span class="o">--</span> <span class="o">*******</span> <span class="o">----</span> 
<span class="o">---</span> <span class="o">*****</span> <span class="o">-----</span> <span class="p">[</span><span class="n">queues</span><span class="p">]</span>
 <span class="o">--------------</span> <span class="o">.&gt;</span> <span class="n">celery</span>           <span class="n">exchange</span><span class="o">=</span><span class="n">celery</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span> <span class="n">key</span><span class="o">=</span><span class="n">celery</span>


<span class="p">[</span><span class="n">tasks</span><span class="p">]</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">backend_cleanup</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">chain</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">chord</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">chord_unlock</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">chunks</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">group</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">map</span>
  <span class="o">.</span> <span class="n">celery</span><span class="o">.</span><span class="n">starmap</span>
  <span class="o">.</span> <span class="n">mon_app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">publish_data</span>
  <span class="o">.</span> <span class="n">mon_app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put_in_cache</span>
  <span class="o">.</span> <span class="n">mon_app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">read_data</span>

<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">165</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Hub</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">165</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">165</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Pool</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">177</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">178</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Consumer</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">179</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Connection</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">206</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">redis</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">6379</span><span class="o">/</span><span class="mi">10</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">206</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">207</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Events</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">238</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">238</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Mingle</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span><span class="mi">238</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">mingle</span><span class="p">:</span> <span class="n">searching</span> <span class="k">for</span> <span class="n">neighbors</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">246</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">mingle</span><span class="p">:</span> <span class="nb">all</span> <span class="n">alone</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">247</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">247</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Gossip</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">251</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">251</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Tasks</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">258</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">258</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Control</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">261</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">261</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">Heart</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">262</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">^--</span> <span class="n">substep</span> <span class="n">ok</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">262</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Consumer</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">event</span> <span class="n">loop</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">263</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">celery</span><span class="nd">@monserver</span> <span class="n">ready</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">263</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="o">|</span> <span class="n">Worker</span><span class="p">:</span> <span class="n">Hub</span><span class="o">.</span><span class="n">register</span> <span class="n">Pool</span><span class="o">...</span>
<span class="p">[</span><span class="mi">2015</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">18</span> <span class="mi">21</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">264</span><span class="p">:</span> <span class="n">DEBUG</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">basic</span><span class="o">.</span><span class="n">qos</span><span class="p">:</span> <span class="n">prefetch_count</span><span class="o">-&gt;</span><span class="mi">8</span>
</code></pre></div>

<p>si on est joueur comme moi, on peut rajouter au lancement du worker un
petit coup de <code>--autoscale=10,3</code></p>
<div class="highlight"><pre><span></span><code><span class="err">$</span> <span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">th</span> <span class="n">worker</span> <span class="o">--</span><span class="n">autoscale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
</code></pre></div>

<p>ce qui fera qu'au démarrage du beat, il demarrera 3 workers d'un coup et
si les ressources systemes le permettent, pourra monter à 10 workers
d'un coup :)</p>
<p>J'ai testé, c'est très efficace.</p>
<p>Dans la liste des tasks de "mon_app" on voit que j'ai pas, deux tasks
comme je l'ai montré, mais trois.<br>
En effet <code>read_data</code> lance <code>put_in_cache</code>, et c'est là que les 10
workers font la teuf parce que j'ai ecrit ce qui suit :</p>
<div class="highlight"><pre><span></span><code><span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">read_data</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">UnModele</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">stuff</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">put_in_cache</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">stuff</span><span class="p">)</span>
</code></pre></div>

<p>C'est une task (<code>read_data</code>) qui en enchaine d'autres</p>
<p>Ici, grosso modo ici je récupère tous les flux RSS de <code>UnModele</code> et pour
chaque flux j'enclenche la mise en cache en rafale puisque 10 workers
bossent pour moi.<br>
Pour finir l'histoire, du coup par la suite, <code>publish_data</code> recupere
les données dans le cache (un Redis bien évidement) et les envoie à
travers les services Twitter, Pocket, Evernote etc...<br>
Je vous laisse imaginer le gain de temps de traitement par rapport à un
traitement sans cache et en série.</p>
<h3><a href="http://supervisord.org/">Supervisor</a></h3>
<p>je n'aborderai pas ici toutes les possibilités de la bête mais juste
comment intégrer Supervisor à des projets Django<br>
voici à quoi ca ressemble dans le fichier
/etc/supervisor/conf.d/mon_projet.conf</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">mon_projet_gunicorn</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">foxmask</span>                                                   <span class="p">;</span> <span class="n">User</span> <span class="n">to</span> <span class="n">run</span> <span class="k">as</span>
<span class="n">directory</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">mon_projet</span>
<span class="n">command</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span>             <span class="p">;</span> <span class="n">Command</span> <span class="n">to</span> <span class="n">start</span> <span class="n">app</span>
<span class="n">autostart</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">autorestart</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">start</span><span class="o">.</span><span class="n">log</span> <span class="p">;</span> <span class="n">Where</span> <span class="n">to</span> <span class="n">write</span> <span class="n">log</span> <span class="n">messages</span>
<span class="n">stderr_logfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">gunicorn</span><span class="o">-</span><span class="n">start</span><span class="o">-</span><span class="n">err</span><span class="o">.</span><span class="n">log</span> <span class="p">;</span> <span class="n">Where</span> <span class="n">to</span> <span class="n">write</span> <span class="n">log</span> <span class="n">messages</span>

<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">mon_projet_worker</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">foxmask</span>                                                        <span class="p">;</span> <span class="n">User</span> <span class="n">to</span> <span class="n">run</span> <span class="k">as</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">mon_projet</span>
<span class="n">command</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">th</span> <span class="n">worker</span> <span class="o">--</span><span class="n">autoscale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">mon_projet</span><span class="o">-</span><span class="n">worker</span><span class="o">.</span><span class="n">log</span>
<span class="n">stderr_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">mon_projet</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="n">err</span><span class="o">.</span><span class="n">log</span>

<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">mon_projet_beat</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">foxmask</span>                                                        <span class="p">;</span> <span class="n">User</span> <span class="n">to</span> <span class="n">run</span> <span class="k">as</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">mon_projet</span>
<span class="n">command</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">th</span> <span class="n">beat</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">trigger</span><span class="o">-</span><span class="n">happy</span><span class="o">-</span><span class="n">beat</span><span class="o">.</span><span class="n">log</span>
<span class="n">stderr_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">mon</span><span class="o">-</span><span class="n">projet</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">trigger</span><span class="o">-</span><span class="n">happy</span><span class="o">-</span><span class="n">beat</span><span class="o">-</span><span class="n">err</span><span class="o">.</span><span class="n">log</span>
</code></pre></div>

<ul>
<li><code>command</code> gere le lancement du process cible</li>
<li><code>directory</code> est le dossier où on a mis le projet django</li>
<li><code>autostart</code> et <code>autorestart</code> permettent de lancer automatiquement la
    <code>command</code> quand supervisor démarre comme par exemple au demarrage du
    serveur, quant à autorestart, il lance aussi <code>command</code> après un
    plantage ou un kill du process</li>
</ul>
<p>pour Celery j'ai defini 2 <code>program</code> (un pour les workers un pour le
beat) afin de séparer les logs et les process plutot que de lancer
celery comme ceci :</p>
<div class="highlight"><pre><span></span><code><span class="n">celery</span> <span class="n">worker</span> <span class="o">-</span><span class="n">B</span>
</code></pre></div>

<p>Ce qui n'est pas recommandé par la doc de Celery.</p>
<p>un autre exemple de conf où j'ai utilisé supervisor : <strong>sentry</strong> :</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">sentry</span><span class="o">-</span><span class="n">web</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">foxmask</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span>
<span class="n">command</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sentry</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">sentry</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">py</span> <span class="n">start</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="n">sentry</span><span class="o">.</span><span class="n">log</span>
<span class="n">stderr_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="n">sentry</span><span class="o">-</span><span class="n">err</span><span class="o">.</span><span class="n">log</span>

<span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">sentry</span><span class="o">-</span><span class="n">worker</span><span class="p">]</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">foxmask</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span>
<span class="n">command</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sentry</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">sentry</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">py</span> <span class="n">celery</span> <span class="n">worker</span> <span class="o">-</span><span class="n">B</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="n">sentry</span><span class="o">.</span><span class="n">log</span>
<span class="n">stderr_logfile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">sentry</span><span class="o">/</span><span class="n">sentry</span><span class="o">-</span><span class="n">err</span><span class="o">.</span><span class="n">log</span>
</code></pre></div>

<p>la façon de lancer le worker n'est pas recommandée mais utilise une
version de celery plus ancienne.</p>
<h3>Alternatives à Celery</h3>
<p>Il existe bien d'autres alternatives à celery</p>
<p>On peut aussi s'orienter vers des systèmes de queueing alternatifs
listés <a href="http://queues.io">ici</a></p>
<p>Dont  </p>
<ul>
<li><a href="http://python-rq.org/">RQ: Simple job queues for Python</a> par l'<a href="http://nvie.com/">auteur</a> du <a href="http://nvie.com/posts/a-successful-git-branching-model/">fameux git worklow</a></li>
<li><a href="http://sametmax.com/redis-pourquoi-et-comment/">Voire carrément exploiter redis directement</a></li>
</ul>
<h3>Alternative à Supervisor</h3>
<p>On trouve <a href="https://circus.readthedocs.org/">Circus</a> mais je n'ai pas
réussi à le faire fonctionner (ca remonte à des mois)</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://www.foxmask.org/post/2016/04/14/job-queue-and-messages-broker-out/">Quand Les "job queue" et les amis "brokers de messages" sont mis au rancart par la stdlib</a></li>
        <li><a href="https://www.foxmask.org/post/2023/05/18/pythno-chatgpt-ccbv-metaclasses/">Python ChatGPT, CCBV, Metaclasses</a></li>
        <li><a href="https://www.foxmask.org/post/2022/05/27/the-call-for-proposals-for-djangocon-us-2022-is-now-open-djangoproject/">The Call for Proposals for DjangoCon US 2022 Is Now Open! - djangoproject</a></li>
        <li><a href="https://www.foxmask.org/post/2022/02/21/hacker-news-clone-askpython/">Hacker News Clone - askpython</a></li>
        <li><a href="https://www.foxmask.org/post/2022/02/08/hacker-news-avec-django/">hacker news avec django</a></li>
        <li><a href="https://www.foxmask.org/post/2022/02/03/jsocoldjango-ratelimit-cache-based-rate-limiting-for-django-github/">jsocol/django-ratelimit: Cache-based rate-limiting for Django - github</a></li>
        <li><a href="https://www.foxmask.org/post/2022/02/01/how-to-add-favicon-to-django-in-4-steps-simpleit/">How to add favicon to Django in 4 steps - simpleit</a></li>
        <li><a href="https://www.foxmask.org/post/2022/01/26/announcing-djangocon-europe-2022-djangoproject/">Announcing DjangoCon Europe 2022 - djangoproject</a></li>
    </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="/feeds/all.rss.xml" target="_blank">FoxMaSk RSS</a>
    </li>
    <li class="list-group-item">
      <a href="https://python.org/" target="_blank">Python</a>
    </li>
    <li class="list-group-item">
      <a href="https://pycon.fr/" target="_blank">PyConFr</a>
    </li>
    <li class="list-group-item">
      <a href="https://pycon.kr/" target="_blank">PyConKr</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.djangoproject.com/" target="_blank">Django</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.django-rest-framework.org/" target="_blank">DRF</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.ansible.com/" target="_blank">Ansible</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.coree-culture.org/?lang=fr" target="_blank">Centre Culturel Coréen</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2023 FoxMaSk
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>Unless otherwise stated, all articles are published under the <a href="http://www.wtfpl.net/about/">WTFPL</a> license.</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://www.foxmask.org/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://www.foxmask.org/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://www.foxmask.org/theme/js/respond.min.js"></script>


    <script src="https://www.foxmask.org/theme/js/bodypadding.js"></script>


</body>
</html>