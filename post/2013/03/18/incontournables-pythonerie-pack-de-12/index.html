<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Incontournables Pythonerie : un pack de 12 s'il te plait ! - Le Free de la Passion</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://foxmask.net/post/2013/03/18/incontournables-pythonerie-pack-de-12/">

        <meta name="author" content="foxmask" />
        <meta name="keywords" content="python,pythonerie" />
        <meta name="description" content="Avec ce billet nous allons voir comment produire un package comme on en voit partout dans le monde opensource (ou pas d&#39;ailleurs) pour livrer une &#34;suite logicielle&#34; à ses clients/utilisateurs. Brève présentation du script : Ce script extrait d&#39;un fichier XML (produit par Autodeploy) les targz installés sur les environnements …" />

        <meta property="og:site_name" content="Le Free de la Passion" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Incontournables Pythonerie : un pack de 12 s&#39;il te plait !"/>
        <meta property="og:url" content="https://foxmask.net/post/2013/03/18/incontournables-pythonerie-pack-de-12/"/>
        <meta property="og:description" content="Avec ce billet nous allons voir comment produire un package comme on en voit partout dans le monde opensource (ou pas d&#39;ailleurs) pour livrer une &#34;suite logicielle&#34; à ses clients/utilisateurs. Brève présentation du script : Ce script extrait d&#39;un fichier XML (produit par Autodeploy) les targz installés sur les environnements …"/>
        <meta property="article:published_time" content="2013-03-18" />
            <meta property="article:section" content="Techno" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="pythonerie" />
            <meta property="article:author" content="foxmask" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://foxmask.net/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://foxmask.net/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://foxmask.net/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://foxmask.net/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://foxmask.net/theme/css/style.css" type="text/css"/>

        <link href="https://foxmask.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion ATOM Feed"/>

        <link href="https://foxmask.net/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Le Free de la Passion RSS Feed"/>


        <link href="https://foxmask.net/feeds/techno.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion Techno ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://foxmask.net/" class="navbar-brand">
Le Free de la Passion            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://foxmask.net/pages/a-propos">
                             À propos
                          </a></li>
                        <li >
                            <a href="https://foxmask.net/category/entrevues.html">Entrevues</a>
                        </li>
                        <li >
                            <a href="https://foxmask.net/category/games.html">Games</a>
                        </li>
                        <li >
                            <a href="https://foxmask.net/category/general.html">General</a>
                        </li>
                        <li >
                            <a href="https://foxmask.net/category/news.html">News</a>
                        </li>
                        <li class="active">
                            <a href="https://foxmask.net/category/techno.html">Techno</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://foxmask.net/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://foxmask.net/post/2013/03/18/incontournables-pythonerie-pack-de-12/"
                       rel="bookmark"
                       title="Permalink to Incontournables Pythonerie : un pack de 12 s'il te plait !">
                        Incontournables Pythonerie : un pack de 12 s'il te plait !
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-03-18T10:00:00+01:00"> lun. 18 mars 2013</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://foxmask.net/tag/python.html">python</a>
        /
	<a href="https://foxmask.net/tag/pythonerie.html">pythonerie</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Avec ce billet nous allons voir comment produire un package comme on en
voit partout dans le monde opensource (ou pas d'ailleurs) pour livrer
une "suite logicielle" à ses clients/utilisateurs.</p>
<p><strong>Brève présentation du script :</strong></p>
<p>Ce script extrait d'un fichier XML (produit par
<a href="http://buildprocess.sourceforge.net/autodeploy.html" title="autodeploy">Autodeploy</a>)
les targz installés sur les environnements.<br>
Puis lit un fichier de configuration pour décider dans quel répertoire
va être télécharger chaque archive. C'est tout ! On mappe ni plus ni
moins un targz dans un dossier.</p>
<p><strong>Prérequis à la lecture de cet article</strong><br>
la lecture des mes billets précédents, vous donnera l'aperçu de ce qui
va suivre, puisque chacun d'eux est une partie du script complet qui
suivra comme je vous l'ai présenté depuis ces derniers jours, notamment
:</p>
<ul>
<li>récupération des arguments entrés sur la ligne de commande soit
    <a href="/post/2013/02/25/incontournables-pythonerie-die-arg">avec
    optparse</a>
    ou
    <a href="/post/2013/03/13/incontournables-pythonerie-parse-parse-parsera-la-derniere-la-derniere/" title="Incontournables Pythonerie : parse parse parsera la dernière la dernière">argpase</a></li>
<li><a href="/post/2013/02/18/de-php-a-python-x-aime-l/" title="de PHP à Python : X aime L">la lecture de fichier
    XML</a></li>
<li><a href="/post/2013/03/04/de-php-a-python-minie-petite-souris">la lecture de fichier de
    configuration</a></li>
<li><a href="/post/2013/03/11/incontournable-pythonerie-bigbrother-is-logging-you">la création de fichier de
    journalisation</a></li>
</ul>
<p>La <em>nouveauté</em> dans cet article est le pseudo "wget" à la sauce Python
pour récupérer les archives</p>
<p>Tout ceci ressemble bien au déroulement d'un script, <a href="https://github.com/foxmask/autodeploy-make-delivery/blob/master/make_delivery.py">ça tombe bien le
voici</a>
:)</p>
<p>Pour utiliser ce script, on tape</p>
<div class="highlight"><pre><span></span>python make_delivery -r RELEASE -e ENV -c CONFIG
</pre></div>


<p>le script traitera ceux ci comme suit :</p>
<div class="highlight"><pre><span></span>    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;%prog -e environment name -r release name. </span><span class="se">\n</span><span class="s2">for example : </span><span class="se">\n</span><span class="s2">python make_delivery -e envname -r 20130101&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--env&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;environment&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the environment name to use to build the delivery&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ENV&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--rel&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;release&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the release name of this delivery (used to name the final package like release-RELEASE-yyyymmdd)&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;RELEASE&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--conf&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;configfile&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the path where the config file is located. This file should contain the name of the environment from which to download the archives. By Default the script will search in ./env_dirs.conf&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./env_dirs.conf&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CONFIG&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="s2">&quot;--log&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;configlogfile&quot;</span><span class="p">,</span>
<span class="n">help</span><span class="o">=</span><span class="s2">&quot;the path where the config file for the loggging is located. By Default the script will search in ~/MakeDelivery/logging.conf&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/MakeDelivery/logging.conf&#39;</span><span class="p">),</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;LOGGING_CONFIG&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">release</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;options -e and -r are mandatory&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="c1">#lets concat release name + date to have a name to use for logfile and directory</span>
        <span class="n">release_name</span> <span class="o">=</span> <span class="n">release_name_main</span> <span class="p">(</span> <span class="n">options</span><span class="o">.</span><span class="n">release</span> <span class="p">)</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="n">release_name_dir</span> <span class="o">=</span> <span class="n">release_name_create</span><span class="p">(</span> <span class="n">release_name</span> <span class="p">)</span>
</pre></div>


<p>Dès lors make_delivery va faire quelques vérifications d'existence du
dossier que j'escompte créé (pour ne pas écrire par dessus pusique je
conserve un historique de toutes les livraisons faites au client).</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">release_name_create</span><span class="p">(</span><span class="n">release_name_dir</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">release_name_dir</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Directory </span><span class="si">%s</span><span class="s2"> already exists. You should change the release number ( -r parameter ) &quot;</span> <span class="p">,</span> <span class="n">release_name_dir</span><span class="p">)</span>
        <span class="nb">exit</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creation of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">release_name_dir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">release_name_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">release_name_dir</span>
</pre></div>


<p>Puis make_delivery appelle le <a href="https://github.com/foxmask/autodeploy-make-delivery/blob/master/get_env.py">module
get_envs</a>
(parsant le fichier XML) pour obtenir les noms des applications de mon
environnement et en extraire les URL de chacune</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">get_env</span> <span class="kn">import</span> <span class="n">get_apps</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="c1">#get the data from the get_env class which read the ConfigWrapper file from autodeploy</span>
<span class="n">environment_datas</span> <span class="o">=</span> <span class="n">get_apps</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
</pre></div>


<p>Puis make_delivery lit le fichier de configuration décrivant comment
structurer ma livraison en indiquant le nom de chaque application avec
son dossier de destination.</p>
<div class="highlight"><pre><span></span><span class="k">[myenv]</span>
<span class="c1">#directory to add to the delivery whatever happens</span>
<span class="na">doc: fake</span>

<span class="k">[myenv_apps]</span>
<span class="na">myapp1: app</span>
<span class="na">myapp2: app</span>
<span class="na">myapp3: null</span>

<span class="k">[myenv_software]</span>
<span class="na">myapp4: app</span>
<span class="na">myapp5: path/to/target</span>
<span class="na">myapp6: null #do nothing for this app</span>
<span class="na">myapp7: .</span>
</pre></div>


<p>Enfin le transfert de fichier se produit et affiche une progress bar
histoire de voir où on en est.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_release</span><span class="p">(</span><span class="n">environment_name</span><span class="p">,</span> <span class="n">release_name_dir</span><span class="p">,</span> <span class="n">environment_datas</span><span class="p">,</span> <span class="n">configfile</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">environment_datas</span><span class="p">:</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Environment =&gt;&gt;&gt; </span><span class="si">%s</span><span class="s2"> Components: </span><span class="si">%s</span><span class="s2"> : Begin &quot;</span> <span class="p">,</span> <span class="n">environment_name</span> <span class="p">,</span> <span class="n">component</span> <span class="p">)</span>

    <span class="n">archives</span> <span class="o">=</span> <span class="n">environment_datas</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">archive_name</span> <span class="ow">in</span> <span class="n">archives</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curdir</span><span class="p">)</span>
    <span class="n">destination_directory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environment_name</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">component</span><span class="p">,</span><span class="n">archive_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">destination_directory</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="c1">#check if the directory exists</span>
    <span class="c1">#if yes ; chdir to it</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">destination_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">destination_directory</span><span class="p">)</span>
    <span class="c1">#otherwise create it then chdir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_directory</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">destination_directory</span><span class="p">)</span>

    <span class="c1">#get the url of the archive</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">archives</span><span class="p">[</span><span class="n">archive_name</span><span class="p">]</span>
    <span class="c1">#get the filename part of the URL to download</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#download the file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Download </span><span class="si">%s</span><span class="s2"> - url </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">archive_name</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">archive_name</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="c1">#get the Content Length</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">getheaders</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#display the prgress on the screen</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading: </span><span class="si">%s</span><span class="s2"> Bytes: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_size</span><span class="p">)</span>

    <span class="n">file_size_dl</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">block_sz</span> <span class="o">=</span> <span class="mi">8192</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1">#read the file getting from the url</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_sz</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">buffer</span><span class="p">:</span>
        <span class="k">break</span>

        <span class="n">file_size_dl</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="c1">#progressbar</span>
        <span class="n">status</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">%10d</span><span class="s2"> [</span><span class="si">%3.2f%%</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file_size_dl</span><span class="p">,</span> <span class="n">file_size_dl</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">file_size</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">status</span><span class="p">,</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Environment =&gt;&gt;&gt; </span><span class="si">%s</span><span class="s2"> Components: </span><span class="si">%s</span><span class="s2"> : End &quot;</span> <span class="p">,</span> <span class="n">environment_name</span> <span class="p">,</span> <span class="n">component</span> <span class="p">)</span>
</pre></div>


<p>Evidement, dans la foulée tout est loggé,</p>
<div class="highlight"><pre><span></span><span class="c1">#set the name of the config logging file from the command line</span>
<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fileConfig</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">configlogfile</span><span class="p">,</span><span class="n">disable_existing_loggers</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="n">FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>

<span class="c1">#write the logfile in the current working dir</span>
<span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="o">+</span><span class="n">release_name</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span> 
</pre></div>


<p>ainsi je n'ai plus qu'à regarder dans mon fichier
release-YYYYMMDD-name.log si j'ai des erreurs (genre une 404 au hasard
;)</p>
<p>Une fois lancée, la commande affiche ceci :</p>
<div class="highlight"><pre><span></span>2013-02-22 10:34:44,398 - make_delivery - INFO - Creation of release-201041.41-20130222
2013-02-22 10:34:44,439 - make_delivery - INFO - Creation of the release 201041.41 from the environment customer1-testing
2013-02-22 10:34:44,439 - make_delivery - INFO - Reading config file /root/MakeDelivery/env_dirs.conf 
2013-02-22 10:34:44,470 - get_env - INFO - Read the Autodeploy config file http://autodeploy.domain.com/ConfigurationWrapper
2013-02-22 10:34:45,059 - make_delivery - INFO - Environment =&gt;&gt;&gt; customer1-testing Components: apps : Begin 
2013-02-22 10:34:45,104 - make_delivery - INFO - Download myapp1 - url  http://maven.domain.com/deliveries/myapp1/releases/myapp_2.19.23_weblogic.tar.gz
2013-02-22 10:34:45,169 - make_delivery - INFO - Downloading: myapp1.19.23_weblogic.tar.gz Bytes: 29585377
2013-02-22 10:34:46,572 - make_delivery - INFO - Download myapp2 - url  http://maven.domain.com/deliveries/myapp2/releases/myapp2_2010.r1.2.44.42_core_weblogic.tar.gz
2013-02-22 10:34:46,652 - make_delivery - INFO - Downloading: myapp2_2010.r1.2.44.42_core_weblogic.tar.gz Bytes: 67769731
2013-02-22 10:34:49,681 - make_delivery - INFO - Download framework - url  http://maven.domain.com/maven2/internal/services/framework/framework/1.16.29/framework-1.16.29-delivery.tar.gz
2013-02-22 10:34:49,733 - make_delivery - INFO - Downloading: framework-1.16.29-delivery.tar.gz Bytes: 11556974
2013-02-22 10:34:50,231 - make_delivery - INFO - Download myapp3 - url  http://maven.domain.com/deliveries/myapp3/releases/myapp3_2010.r1.1.37.42_weblogic.tar.gz
2013-02-22 10:34:50,303 - make_delivery - INFO - Downloading: myapp3_2010.r1.1.37.42_weblogic.tar.gz Bytes: 51400921
2013-02-22 10:34:52,224 - make_delivery - INFO - Download portal - url  http://maven.domain.com/maven2/internal/services/portal/portal/1.10.18/portal-1.10.18-delivery.tar.gz
2013-02-22 10:34:52,276 - make_delivery - INFO - Downloading: portal-1.10.18-delivery.tar.gz Bytes: 16350871
2013-02-22 10:34:52,969 - make_delivery - INFO - Download myapp4 - url  http://repo.domain.com/deliveries/myapp4/releases/myapp4_2010.r1.1.31.38_weblogic.tar.gz
2013-02-22 10:34:53,061 - make_delivery - INFO - Downloading: myapp4_2010.r1.1.31.38_weblogic.tar.gz Bytes: 60468113
2013-02-22 10:34:55,450 - make_delivery - INFO - Environment =&gt;&gt;&gt; customer1-testing Components: apps : End 
2013-02-22 10:34:55,450 - make_delivery - INFO - Environment =&gt;&gt;&gt; customer1-testing Components: software : Begin 
2013-02-22 10:34:56,677 - make_delivery - INFO - Download database - url  http://maven.domain.com/maven2/internal/database/2010.r1.3.23.41/database-2010.r1.3.23.41.tar.gz
2013-02-22 10:34:56,727 - make_delivery - INFO - Downloading: database-2010.r1.3.23.41.tar.gz Bytes: 4902673
2013-02-22 10:35:11,832 - make_delivery - INFO - Download database2 - url  http://maven.domain.com/maven2/internal/database2/database2/1.48.12/database2-1.48.12-delivery.tar.gz
2013-02-22 10:35:11,868 - make_delivery - INFO - Downloading: database2-1.48.12-delivery.tar.gz Bytes: 10995334
2013-02-22 10:35:12,321 - make_delivery - INFO - Environment =&gt;&gt;&gt; customer1-testing Components: software : End 
2013-02-22 10:35:12,321 - root - INFO - Environment =&gt;&gt;&gt; customer1-testing download successfull completed
</pre></div>


<p>On m'a cité il y a quelques temps l'usage de la lib
"<a href="http://docs.python-requests.org/en/latest/">requests</a>" plutôt que
urllib2 car plus souple et facile de mise en oeuvre notamment pour gérer
l'auth. Ici je n'ai nul besoin d'auth c'est un accès réseau sur
l'intranet ;)</p>
<p>Si vous voulez zieuter de plus près les sources de ce script, ou plus
simplement en avoir une vue d'ensemble, <a href="https://github.com/foxmask/autodeploy-make-delivery">il se trouve ici sur
github</a></p>
<p>Etant loin d'être un pro dans le domaine c'est modestement que j'ai
tenté l'exercice de vous montrer étape par étape, comment "ça marche"
chez moi.</p>
<p>Ce script marche parfaitement en prod, et me permet d'économiser un
temps monstreux :</p>
<ul>
<li>plus besoin de faire les mkdir</li>
<li>plus besoin de faire les wget des presque 60 archives que
    constituent une "livraison" à mes clients</li>
<li>le script ne prend que 3 minutes à produire ma livraison pour le
    plus "gros" client.<br>
    Avant ce script il me fallait en passer par mkdir + wget avec
    risque d'erreurs potentielles ... => 1heure</li>
</ul>
<p>J'ai dans le pipe, la création d'une RELEASE NOTE listant au client les
éléments fournis, dans un doc PDF, document note que je ponds
manuellement aujourd'hui : un tableau des versions avec instructions
d'installation => re une heure de perdue ... alors qu'apres un test
d'une soluce python ça me prendrait 1min :)</p>
<p>Voilou :</p>
<p>N'hésitez pas à me faire un retour, si j'ai pu vous donner envie de vous
mettre à python (si vous veniez de php comme bibi), si vous avez trouvé
ça trop "weak"/trop juste, trop chiant, ou juste "pas mal", je suis prêt
à tout entendre ;)</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://foxmask.net/post/2013/11/05/incontournables-pythonerie-importerror-no-module-named-dans-un-virtualenv/">Incontournables Pythonerie : ImportError: No module named 'xxx' dans un virtualenv</a></li>
        <li><a href="https://foxmask.net/post/2013/07/01/incontournables-pythonerie-le-fichier-requirements-txt/">Incontournables Pythonerie : le fichier requirements.txt</a></li>
        <li><a href="https://foxmask.net/post/2013/06/24/incontournables-pythonerie-publier-son-appli-django-sans-la-config-perso/">Incontournables Pythonerie : publier son appli Django sans la config perso</a></li>
        <li><a href="https://foxmask.net/post/2013/03/13/incontournables-pythonerie-parse-parse-parsera-la-derniere-la-derniere/">Incontournables Pythonerie : parse parse parsera la dernière la dernière</a></li>
        <li><a href="https://foxmask.net/post/2013/03/11/incontournable-pythonerie-bigbrother-is-logging-you/">Incontournables Pythonerie : BigBrother is logging you</a></li>
    </ul>
</section>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'foxmasktriggerhappyeu'; // required: replace example with your forum shortname

                    var disqus_identifier = 'incontournables-pythonerie-pack-de-12';
                var disqus_url = 'https://foxmask.net/post/2013/03/18/incontournables-pythonerie-pack-de-12/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="https://foxmask.net/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-4">
      <a href="https://foxmask.net/tag/ansible.html">ansible</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://foxmask.net/tag/apachemysqlphp.html">ApacheMySqlPHP</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://foxmask.net/tag/autobahn.html">autobahn</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://foxmask.net/tag/crossbar.html">crossbar</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://foxmask.net/tag/debian.html">debian</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://foxmask.net/tag/django.html">django</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://foxmask.net/tag/evernote.html">Evernote</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://foxmask.net/tag/fabric.html">Fabric</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://foxmask.net/tag/havefnubb.html">HaveFnuBB</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://foxmask.net/tag/jelix.html">Jelix</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://foxmask.net/tag/joplin.html">Joplin</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://foxmask.net/tag/linux.html">linux</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://foxmask.net/tag/oracle.html">oracle</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://foxmask.net/tag/pelican.html">pelican</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://foxmask.net/tag/pycharm.html">PyCharm</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://foxmask.net/tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="https://foxmask.net/tag/pythonerie.html">pythonerie</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="https://foxmask.net/tag/triggerhappy.html">triggerhappy</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="https://foxmask.net/tag/wallabag.html">wallabag</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="https://foxmask.net/tag/wampws.html">wampws</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/foxmask">@foxmask</a> on GitHub
</li>
<!-- End Sidebar/Github -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://sametmax.com" target="_blank">Sam et Max</a>
    </li>
    <li class="list-group-item">
      <a href="https://foxmask.net/feeds/all.rss.xml" target="_blank">RSS</a>
    </li>
    <li class="list-group-item">
      <a href="https://foxmask.net/feeds/all.atom.xml" target="_blank">Atom</a>
    </li>
    <li class="list-group-item">
      <a href="http://planetpython.org/" target="_blank">Python Planet</a>
    </li>
    <li class="list-group-item">
      <a href="http://django-planet.com/" target="_blank">Django Planet</a>
    </li>
    <li class="list-group-item">
      <a href="http://www.django-fr.org/planete/" target="_blank">Django-Fr Planet</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 FoxMaSk
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>Unless otherwise stated, all articles are published under the <a href="http://www.wtfpl.net/about/">WTFPL</a> license.</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://foxmask.net/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://foxmask.net/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://foxmask.net/theme/js/respond.min.js"></script>


    <script src="https://foxmask.net/theme/js/bodypadding.js"></script>

<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = 'https://foxmask.net/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'foxmask',
    count: 5,
    skip_forks: false,
    target: '#gh_repos'
  });
});
</script>
<script src="https://foxmask.net/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'foxmasktriggerhappyeu'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->


</body>
</html>