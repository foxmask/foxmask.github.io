<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Trigger Happy comment pondre son propre module - Le Free de la Passion</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://www.foxmask.org/post/2013/12/09/trigger-happy-comment-pondre-son-propre-module/">

        <meta name="author" content="foxmask" />
        <meta name="keywords" content="Django,python,TriggerHappy" />
        <meta name="description" content="Intro: Tout comme vous avez des outils pour produire vos sites avec des CMS ou Blogs, Trigger Happy entre dans une nouvelle catégorie d&#39;outils vous permettant de gérer cette fois ci l&#39;interconnexion de services internet, en fonction d&#39;évènements : sur la toile sur vos propres comptes &#34;internet&#34;. Exemples : Quand une nouvelle …" />

        <meta property="og:site_name" content="Le Free de la Passion" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Trigger Happy comment pondre son propre module"/>
        <meta property="og:url" content="https://www.foxmask.org/post/2013/12/09/trigger-happy-comment-pondre-son-propre-module/"/>
        <meta property="og:description" content="Intro: Tout comme vous avez des outils pour produire vos sites avec des CMS ou Blogs, Trigger Happy entre dans une nouvelle catégorie d&#39;outils vous permettant de gérer cette fois ci l&#39;interconnexion de services internet, en fonction d&#39;évènements : sur la toile sur vos propres comptes &#34;internet&#34;. Exemples : Quand une nouvelle …"/>
        <meta property="article:published_time" content="2013-12-09" />
            <meta property="article:section" content="Techno" />
            <meta property="article:tag" content="Django" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="TriggerHappy" />
            <meta property="article:author" content="foxmask" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://www.foxmask.org/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://www.foxmask.org/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://www.foxmask.org/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://www.foxmask.org/theme/css/style.css" type="text/css"/>

        <link href="https://www.foxmask.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion ATOM Feed"/>

        <link href="https://www.foxmask.org/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Le Free de la Passion RSS Feed"/>
        <link href="https://www.foxmask.org/feeds/techno.atom.xml" type="application/atom+xml" rel="alternate"
              title="Le Free de la Passion Techno ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://www.foxmask.org/" class="navbar-brand">
Le Free de la Passion            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://www.foxmask.org/pages/a-propos">
                             À propos
                          </a></li>
                        <li >
                            <a href="https://www.foxmask.org/category/games.html">Games</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/general.html">General</a>
                        </li>
                        <li >
                            <a href="https://www.foxmask.org/category/korea.html">Korea</a>
                        </li>
                        <li class="active">
                            <a href="https://www.foxmask.org/category/techno.html">Techno</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://www.foxmask.org/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://www.foxmask.org/post/2013/12/09/trigger-happy-comment-pondre-son-propre-module/"
                       rel="bookmark"
                       title="Permalink to Trigger Happy comment pondre son propre module">
                        Trigger Happy comment pondre son propre module
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-12-09T15:49:00+01:00"> lun. 09 décembre 2013</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://www.foxmask.org/tag/django.html">Django</a>
        /
	<a href="https://www.foxmask.org/tag/python.html">python</a>
        /
	<a href="https://www.foxmask.org/tag/triggerhappy.html">TriggerHappy</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><strong>Intro:</strong></p>
<p>Tout comme vous avez des outils pour produire vos sites avec des CMS ou
Blogs, Trigger Happy entre dans une nouvelle catégorie d'outils vous
permettant de gérer cette fois ci l'interconnexion de services internet,
en fonction d'évènements :</p>
<ul>
<li>sur la toile</li>
<li>sur vos propres comptes "internet".</li>
</ul>
<p>Exemples :</p>
<ul>
<li>Quand une nouvelle est publiée sur un site web, je souhaite qu'elle
    soit stockée dans mon compte Evernote ou Pocket, publiée sur
    Twitter, son mur Facebook, etc...</li>
<li>Quand j'ajoute une note dans mon compte Evernote, je souhaite
    l'envoyer dans mon compte Pocket</li>
<li>Quand un tweet sur un sujet tombe, l'envoyer dans mon compte
    Pocket/Evernote/Whatever</li>
<li>etc...</li>
</ul>
<p>Tout ceci est très largement inspiré du très bon service IFTTT
permettant ces échanges.</p>
<p>Ce qui va suivre va donc vous montrer (avec du code "oui-oui"), comment
(vous) "brancher" un service de plus avec Trigger Happy et (presque) ne
plus vous en préoccuper ;)</p>
<p><strong>Pré-requis:</strong><br>
Ce qu'il vous faut posséder en premier lieu pour produire votre module
Trigger-Happy :</p>
<ul>
<li>Connaitre Django</li>
<li>un compte sur le service "cible" (c'est possible sans, mais c'est
    mieux avec, on va dire hein)</li>
<li>et ... de l'huile de coude (encore que ça ne soit pas la mer à boire
    après ce qui suit)</li>
</ul>
<p><strong>Quick start:</strong><br>
si vous êtes pressé, le plus simple est encore de voir le README du
module <a href="https://github.com/foxmask/django-th-pocket">Trigger Happy :
Pocket</a>, de cloner le
module et de changer partout "pocket" par "montrucquidechireduponey"
partout ;)</p>
<p><strong>Architecturationesse:</strong><br>
Le service que vous produirez se compose comme un module python. Pour
bien visualiser les explications ci dessous je prendrai comme exemple
<a href="https://github.com/foxmask/django-th-pocket/">django-th-pocket</a>.</p>
<p>L'architecturationnesseeee en elle-même est identique à celle d'un
dossier d'un module django.</p>
<p>Exemple :</p>
<div class="highlight"><pre><span></span><code><span class="n">th_pocket</span><span class="o">/</span><span class="p">:</span>
<span class="n">forms</span><span class="o">.</span><span class="n">py</span>
<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="n">models</span><span class="o">.</span><span class="n">py</span>
<span class="n">my_pocket</span><span class="o">.</span><span class="n">py</span>

<span class="n">th_pocket</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">pocketform</span><span class="p">:</span>
<span class="n">wz</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">form</span><span class="o">.</span><span class="n">html</span>
<span class="n">wz</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">form</span><span class="o">.</span><span class="n">html</span>

<span class="n">th_pocket</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">pocketprovider</span><span class="p">:</span>
<span class="n">edit_provider</span><span class="o">.</span><span class="n">html</span>
</code></pre></div>

<p><strong>En détails, fichier par fichier</strong><br>
Pas de panique c'est court !</p>
<p><strong>En premier le modèle : models.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django_th.models.services</span> <span class="kn">import</span> <span class="n">Services</span>


<span class="k">class</span> <span class="nc">Pocket</span><span class="p">(</span><span class="n">Services</span><span class="p">):</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tweet_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;TriggerService&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s1">&#39;django_th&#39;</span>
</code></pre></div>

<p>ici 2 impératifs,<br>
1) appeler le modèle service de Trigger Happy pour en hériter, soit :</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django_th.models.services</span> <span class="kn">import</span> <span class="n">Services</span>


<span class="k">class</span> <span class="nc">Pocket</span><span class="p">(</span><span class="n">Services</span><span class="p">):</span>
<span class="o">...</span>
</code></pre></div>

<p>2) pour la lisibilite de votre base mettre un app_label cohérent, soit
:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s1">&#39;django_th&#39;</span>
</code></pre></div>

<p><strong>En second, le formulaire : forms.py</strong><br>
C'est un simple formulaire Django, un ModelForm banal, qui appellera le
modèle susmentionné</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">th_pocket.models</span> <span class="kn">import</span> <span class="n">Pocket</span>

<span class="k">class</span> <span class="nc">PocketForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for to handle Pocket service</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Pocket</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">PocketProviderForm</span><span class="p">(</span><span class="n">PocketForm</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PocketConsummerForm</span><span class="p">(</span><span class="n">PocketForm</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p>Ici en sus, on fournit 2 classes supplémentaires <em>PocketProviderForm</em> et
<em>PocketConsummerForm</em> pour permettre lors de la création d'un Trigger,
de disposer du formulaire de Pocket, soit quand on décide que Pocket est
la source de données (donc le Provider) soit la cible (le Consummer)</p>
<p><strong>les Templates</strong><br>
Ensuite arrive les templates situés dans
th_pocket/templates/pocketform. Ceux ci sont curieusement nommé
wz-1-form.html et wz-3-form.html</p>
<p>Explications : Trigger Happy créé ses triggers avec un Wizard constitué
de 5 étapes.</p>
<p>Etape 1 je choisi le service source (wz-0-form.html)<br>
Etape 2 j'indique où sont les informations du service choisi étape 1
(wz-1-form.html)<br>
Etape 3 je choisi le service cible (wz-2-form.html)<br>
Etape 4 je saisie les infos de stockage du service choisi étape 3
(wz-3-form.html)<br>
Etape 5 je nomme mon Trigger ;) (wz-4-form.html)</p>
<p>Les 2 formulaires ici sont donc pour les étapes 2 et 4.<br>
Quasiment tous les services peuvent servir de source ou cible, d'où la
présence de ces 2 formulaires.<br>
Ainsi en utilisant comme source de données Evernote j'appellerai le
form th_evernote/templates/evernoteform/wz-1-form.html puis pour Pocket
comme "cible" th_pocket/templates/pocketform/wz-3-form.html.</p>
<p>Le dernier formulaire
th_pocket/templates/pocketprovider/edit_provider.html permet quant à
lui de modifier des informations relatives à Pocket pour le Trigger
voulu. Chaque service disposant de son propre template pour la même
fonction.</p>
<p><strong>la Glue</strong><br>
Tout ceci permet d'indiquer, via les formulaires du wizard, d'où vient
l'information et où je la stocke. Mais il manque le plus important, la
glue entre tout ceci. C'est là le le rôle du module <strong>my_pocket.py</strong></p>
<p>Avant d'éventuellement vous faire mal aux yeux, je vais vous écrire en
français dans le texte, le but du module :</p>
<p>Celui ci permet 3 choses :</p>
<ol>
<li>) authentifier "son" Trigger Happy aupres de Pocket (via la methode
    auth)</li>
<li>) récupérer les données depuis son compte Pocket, en l'occurence,
    les URL qu'on y aura mises (via la méthode process_data)</li>
<li>) enregistrer les données provenant d'un service 'Provider' (via la
    méthode save_data)</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># django_th classes</span>
<span class="kn">from</span> <span class="nn">django_th.services.services</span> <span class="kn">import</span> <span class="n">ServicesMgr</span>
<span class="kn">from</span> <span class="nn">django_th.models</span> <span class="kn">import</span> <span class="n">UserService</span><span class="p">,</span> <span class="n">ServicesActivated</span>
<span class="c1"># django classes</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.utils.log</span> <span class="kn">import</span> <span class="n">getLogger</span>

<span class="c1"># pocket API</span>
<span class="kn">import</span> <span class="nn">pocket</span>
<span class="kn">from</span> <span class="nn">pocket</span> <span class="kn">import</span> <span class="n">Pocket</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">handle process with pocket</span>
<span class="sd">put the following in settings.py</span>

<span class="sd">TH_POCKET = {</span>
<span class="sd">&#39;consummer_key&#39;: &#39;abcdefghijklmnopqrstuvwxyz&#39;,</span>
<span class="sd">}</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;django_th.trigger_happy&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ServicePocket</span><span class="p">(</span><span class="n">ServicesMgr</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">trigger_id</span><span class="p">,</span> <span class="n">date_triggered</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the data from the service</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datas</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># pocket uses a timestamp date format</span>
        <span class="n">date_triggered</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">timetuple</span><span class="p">(</span><span class="n">date_triggered</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">pocket_instance</span> <span class="o">=</span> <span class="n">pocket</span><span class="o">.</span><span class="n">Pocket</span><span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">TH_POCKET</span><span class="p">[</span><span class="s1">&#39;consummer_key&#39;</span><span class="p">],</span> <span class="n">token</span><span class="p">)</span>

            <span class="c1"># get the data from the last time the trigger have been started</span>
            <span class="c1"># timestamp form</span>
            <span class="n">pockets</span> <span class="o">=</span> <span class="n">pocket_instance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">since</span><span class="o">=</span><span class="n">date_triggered</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pockets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;list&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pocket</span> <span class="ow">in</span> <span class="n">pockets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>

                    <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">pocket</span><span class="p">[</span><span class="s1">&#39;resolved_url&#39;</span><span class="p">],</span>
                                  <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">pocket</span><span class="p">[</span><span class="s1">&#39;resolved_title&#39;</span><span class="p">],</span>
                                  <span class="s1">&#39;tweet_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">datas</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">trigger_id</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        let&#39;s save the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">th_pocket.models</span> <span class="kn">import</span> <span class="n">Pocket</span>

        <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># get the pocket data of this trigger</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">Pocket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trigger_id</span><span class="o">=</span><span class="n">trigger_id</span><span class="p">)</span>

            <span class="n">pocket_instance</span> <span class="o">=</span> <span class="n">pocket</span><span class="o">.</span><span class="n">Pocket</span><span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">TH_POCKET</span><span class="p">[</span><span class="s1">&#39;consummer_key&#39;</span><span class="p">],</span> <span class="n">token</span><span class="p">)</span>

            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">item_id</span> <span class="o">=</span> <span class="n">pocket_instance</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">(</span><span class="n">trigger</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

            <span class="n">sentance</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pocket </span><span class="si">{}</span><span class="s1"> created&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sentance</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="s2">&quot;no token provided for trigger ID </span><span class="si">%s</span><span class="s2"> and link </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">trigger_id</span><span class="p">,</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        let&#39;s auth the user to the Service</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callbackUrl</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">get_host</span><span class="p">(),</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;pocket_callback&#39;</span><span class="p">))</span>

        <span class="n">request_token</span> <span class="o">=</span> <span class="n">Pocket</span><span class="o">.</span><span class="n">get_request_token</span><span class="p">(</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">TH_POCKET</span><span class="p">[</span><span class="s1">&#39;consummer_key&#39;</span><span class="p">],</span>
            <span class="n">redirect_uri</span><span class="o">=</span><span class="n">callbackUrl</span><span class="p">)</span>

        <span class="c1"># Save the request token information for later</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;request_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_token</span>

        <span class="c1"># URL to redirect user to, to authorize your app</span>
        <span class="n">auth_url</span> <span class="o">=</span> <span class="n">Pocket</span><span class="o">.</span><span class="n">get_auth_url</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">request_token</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="o">=</span><span class="n">callbackUrl</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">auth_url</span>

    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called from the Service when the user accept to activate it</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># finally we save the user auth token</span>
            <span class="c1"># As we already stored the object ServicesActivated</span>
            <span class="c1"># from the UserServiceCreateView now we update the same</span>
            <span class="c1"># object to the database so :</span>
            <span class="c1"># 1) we get the previous objet</span>
            <span class="n">us</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">ServicesActivated</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ServicePocket&#39;</span><span class="p">))</span>
            <span class="c1"># 2) then get the token</span>
            <span class="n">access_token</span> <span class="o">=</span> <span class="n">Pocket</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">(</span>
                <span class="n">consumer_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">TH_POCKET</span><span class="p">[</span><span class="s1">&#39;consummer_key&#39;</span><span class="p">],</span>
                <span class="n">code</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;request_token&#39;</span><span class="p">])</span>

            <span class="n">us</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">access_token</span>
            <span class="c1"># 3) and save everything</span>
            <span class="n">us</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">return</span> <span class="s1">&#39;pocket/callback.html&#39;</span>
</code></pre></div>

<p>enfin comme on peut l'apercevoir dans le code, des appels à la
configuration du module ont lieu, voici donc à quoi elle ressemblerait
pour le module Trigger Happy Pocket:</p>
<p><strong>settings.py</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">TH_SERVICES</span> <span class="o">=</span> <span class="p">(</span>
   <span class="o">...</span>
    <span class="s1">&#39;th_pocket.my_pocket.ServicePocket&#39;</span><span class="p">,</span>
   <span class="o">...</span>
<span class="p">)</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
   <span class="o">....</span>
    <span class="s1">&#39;th_pocket&#39;</span><span class="p">,</span>
   <span class="o">...</span>
<span class="p">)</span>

<span class="c1"># votre clé perso fournie par le service POCKET </span>
<span class="n">TH_POCKET</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;consumer_key&#39;</span><span class="p">:</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>Si vous ne connaissez pas IFTTT et/ou pour les plus courageux qui se
sont donnés la peine de lire jusque là et/ou les curieux de comprendre
comme la machinerie tourne :<br>
<strong>Sous le capot : mais comment ça marche-t-il-tu-c'truc ?</strong><br>
Il y a 2 parties:</p>
<ul>
<li>la première visible, vous permet de "brancher" vos services entre
    eux via un wizard de 5 pages et de voir quand tel ou tel service a
    fourni des nouvelles neuves ;)</li>
<li>la seconde est un batch qui tourne à intervalle régulier qui va
    s'occuper d'aller récupérer ses fameuses "nouvelles neuves" et les
    expédier là où vous l'avez décidé</li>
</ul>
<p>Comment ce batch s'en sort, alors que je ne sais pas d'avance quels sont
les services existants ?<br>
Ceci est géré par le biais de la variable TH_SERVICES, indiquant les
services que VOUS avez ajouté (tout comme vous mettez le nom de
l'application "django" dans INSTALLED_APPS). Ensuite "Trigger Happy" va
utiliser cette variable pour vous permettre de vous en servir dans le
Wizard mentionné plus tôt. Ensuite le batch récupère ces services
activés par vos soins, et utilise les "Glues" de chaque service existant
my_pocket, my_evernote, etc, et joue son scénario !</p>
<p>Voilà ! A présent vous êtes devenu maitre de vos données persos !</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://www.foxmask.org/post/2015/08/24/shoot-an-arrow-with-ansible-in-the-triggerhappy-target/">Shoot an Arrow with Ansible in the TriggerHappy target</a></li>
        <li><a href="https://www.foxmask.org/post/2015/08/18/django-trigger-happy-0-11-0-english-version/">Django Trigger Happy 0.11.0 English Version</a></li>
        <li><a href="https://www.foxmask.org/post/2015/08/17/django-trigger-happy-0-11-0/">Django Trigger Happy 0.11.0</a></li>
        <li><a href="https://www.foxmask.org/post/2015/04/23/django-trigger-happy-0-10-x-and-his-friends/">Django Trigger Happy 0.10.x and his friends</a></li>
        <li><a href="https://www.foxmask.org/post/2015/04/21/django-trigger-happy-0-10-x-et-ses-amis/">Django Trigger Happy 0.10.x et ses amis</a></li>
        <li><a href="https://www.foxmask.org/post/2014/12/01/trigger-happy-creer-un-module/">Trigger Happy : Créer un module - la doc</a></li>
        <li><a href="https://www.foxmask.org/post/2014/11/27/django-paris-numa-novembre-2014-demo-live/">Django Paris - Novembre 2014 - Numa : Demo Live</a></li>
        <li><a href="https://www.foxmask.org/post/2014/10/22/django-trigger-happy-declenche-heureuse-rafale-maj/">Django Trigger Happy - déclenche une heureuse rafale de mises à jour</a></li>
    </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="/feeds/all.rss.xml" target="_blank">FoxMaSk RSS</a>
    </li>
    <li class="list-group-item">
      <a href="https://python.org/" target="_blank">Python</a>
    </li>
    <li class="list-group-item">
      <a href="https://pycon.fr/" target="_blank">PyConFr</a>
    </li>
    <li class="list-group-item">
      <a href="https://pycon.kr/" target="_blank">PyConKr</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.djangoproject.com/" target="_blank">Django</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.django-rest-framework.org/" target="_blank">DRF</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.ansible.com/" target="_blank">Ansible</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.coree-culture.org/?lang=fr" target="_blank">Centre Culturel Coréen</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2023 FoxMaSk
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>Unless otherwise stated, all articles are published under the <a href="http://www.wtfpl.net/about/">WTFPL</a> license.</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://www.foxmask.org/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://www.foxmask.org/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://www.foxmask.org/theme/js/respond.min.js"></script>


    <script src="https://www.foxmask.org/theme/js/bodypadding.js"></script>


</body>
</html>